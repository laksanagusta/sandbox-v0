# Docker Compose for Production Deployment
# 
# This file orchestrates both the sandbox-v0 frontend and MCP server.
# 
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose logs -f        # View logs
#   docker-compose down           # Stop all services
#   docker-compose pull           # Pull latest images
#
# Environment files:
#   - .env: General environment variables
#   - mcp.env: MCP server credentials (Google OAuth, Zoom API)

version: '3.8'

services:
  # ============================================
  # Sandbox V0 - Frontend + Express Backend
  # ============================================
  sandbox:
    image: laksanadika/reika-fe:latest
    container_name: sandbox-v0
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MCP_TRANSPORT=http
      - MCP_SERVER_URL=http://mcp-server:3003
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # MCP Server - Google/Zoom Integration
  # ============================================
  mcp-server:
    image: laksanadika/mcp-server:latest
    container_name: mcp-server
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=production
      - MCP_TRANSPORT=http
      - MCP_HTTP_PORT=3003
    env_file:
      - mcp.env  # Contains GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, ZOOM credentials, etc.
    volumes:
      # Mount tokens.json for Google OAuth persistence
      - ./tokens.json:/app/tokens.json:rw
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/mcp/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  app-network:
    driver: bridge

# Optional: Named volumes for data persistence
volumes:
  mcp-data:
    driver: local
